<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отчеты</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .report-list {
            margin-bottom: 20px;
        }
        .report-item {
            margin-bottom: 10px;
        }
        .download-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .download-button:hover {
            background-color: #45a049;
        }
        .create-report-container {
            margin-bottom: 20px;
        }
        .create-report-container select {
            padding: 10px;
            margin-right: 10px;
        }
    </style>
</head>
<body>

    <h1>Все отчеты</h1>

    <!-- Форма для выбора периода -->
    <div class="create-report-container">
        <label for="reportPeriod">Выберите период: </label>
        <select id="reportPeriod">
            <option value="week">Неделя</option>
            <option value="month">Месяц</option>
            <option value="year">Год</option>
        </select>
        <button class="download-button" onclick="createReport()">Создать отчет</button>
    </div>

    <div class="report-list" id="reportList"></div>

    <script>
        // Функция для получения всех отчетов
        function fetchReports() {
            fetch('/api/reports/get/')
                .then(response => response.json())
                .then(data => {
                    const reportListContainer = document.getElementById('reportList');
                    reportListContainer.innerHTML = ''; // Очищаем контейнер

                    data.reports.forEach(report => {
                        const reportItem = document.createElement('div');
                        reportItem.classList.add('report-item');
                        reportItem.innerHTML = `
                            <h3>Отчет за ${report.period}</h3>
                            <p>Дата создания: ${report.date_created}</p>
                            <button class="download-button" onclick="downloadReport(${report.id})">Скачать файл</button>
                        `;
                        reportListContainer.appendChild(reportItem);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке отчетов:', error);
                });
        }

        // Функция для создания отчета
        function createReport() {
            const period = document.getElementById('reportPeriod').value;
            let formData = new FormData()
            formData.append('period', period)

            fetch('/api/reports/new/', {
                method: 'POST',
                headers: {
                    'X-CSRFtoken': '{{ csrf_token }}',
                },
                body: formData
            })
            .then(response => {
                window.location.reload();
            })
            .catch(error => {
                console.error('Ошибка:', error);
            });
        }

        // Функция для скачивания отчета
        function downloadReport(reportId) {
            fetch(`/api/reports/get/${reportId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `report_${reportId}.txt`;
                link.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Ошибка:', error);
            });
        }

        // Загружаем отчеты при загрузке страницы
        window.onload = fetchReports;
    </script>

</body>
</html>
